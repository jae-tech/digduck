name: Deploy Dig-Duck to S3, CloudFront and EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "ë°°í¬ ëŒ€ìƒ ì„ íƒ"
        required: true
        default: "both"
        type: choice
        options:
          - frontend
          - backend
          - both

env:
  DOCKER_IMAGE: cinnamatcha/dig-duck-api
  APP_DIR: /home/cinnamon/dig-duck

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          echo "=== ë³€ê²½ëœ íŒŒì¼ë“¤ ==="
          git diff --name-only HEAD~1 HEAD || echo "ì´ˆê¸° ì»¤ë°‹"
          echo "===================="

          # Frontend ë³€ê²½ ê°ì§€ (dig-duck ì•± + shared packages)
          if git diff --name-only HEAD~1 HEAD | grep -E "^(apps/dig-duck/|packages/)" > /dev/null || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend ë³€ê²½ ê°ì§€"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "âŒ Frontend ë³€ê²½ ì—†ìŒ"
          fi

          # Backend ë³€ê²½ ê°ì§€ (apps/api í´ë” + shared packages)
          if git diff --name-only HEAD~1 HEAD | grep -E "^(apps/api/|packages/)" > /dev/null || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend ë³€ê²½ ê°ì§€"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "âŒ Backend ë³€ê²½ ì—†ìŒ"
          fi

  deploy-frontend:
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.frontend == 'true') || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.deploy_target == 'frontend' || github.event.inputs.deploy_target == 'both'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Build Dig-Duck app
        run: pnpm build --filter=dig-duck
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_APP_ENV: production
          VITE_LOG_LEVEL: error
          VITE_ENABLE_DEVTOOLS: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Sync to S3
        run: |
          aws s3 sync apps/dig-duck/dist/ s3://digduck.app --delete --cache-control max-age=60 --exclude "*" --include "*.html"
          aws s3 sync apps/dig-duck/dist/ s3://digduck.app --delete --cache-control max-age=31536000 --exclude "*.html"

      - name: Invalidate CloudFront Cache
        run: |
          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "âœ… CloudFront Distribution ID ì¡´ì¬, ìºì‹œ ë¬´íš¨í™” ì§„í–‰"
            aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
            echo "âœ… CloudFront ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"
          else
            echo "âš ï¸ CLOUDFRONT_DISTRIBUTION_ID secretì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
            echo "CloudFront ìºì‹œ ë¬´íš¨í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "ğŸ’¡ ì„¤ì • ë°©ë²•: GitHub Repository Settings > Secretsì—ì„œ CLOUDFRONT_DISTRIBUTION_ID ì¶”ê°€"
          fi

      - name: Frontend deployment notification
        run: echo "âœ… Frontend ë°°í¬ ì™„ë£Œ! S3 + CloudFront ì—…ë°ì´íŠ¸ë¨"

  build-and-deploy:
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.backend == 'true') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.deploy_target == 'backend' || github.event.inputs.deploy_target == 'both'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Make Docker Env
        run: |
          cd apps/api
          touch ./.env
          echo "${{ secrets.DOCKER_ENV }}" > ./.env
          echo "âœ… GitHub Secretsì—ì„œ .env íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo "ìƒì„±ëœ .env íŒŒì¼ í™•ì¸:"
          ls -la .env

      - name: Generate Prisma Client
        run: cd apps/api && pnpm db:generate

      - name: Build API
        run: pnpm build --filter=api

      - name: Build Docker image
        run: |
          # .env íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -f "apps/api/.env" ]; then
            echo "âœ… .env íŒŒì¼ ì¡´ì¬, Docker ë¹Œë“œ ì§„í–‰"
            docker build -t dig-duck-api:latest -f apps/api/Dockerfile .
          else
            echo "âŒ .env íŒŒì¼ ì—†ìŒ, Docker ë¹Œë“œ ì§„í–‰"
            docker build -t dig-duck-api:latest -f apps/api/Dockerfile .
          fi

      - name: Login to Docker Registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Tag and push Docker image
        run: |
          docker tag dig-duck-api:latest ${{ env.DOCKER_IMAGE }}:latest
          docker tag dig-duck-api:latest ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:${{ github.sha }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: github-actions
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          timeout: 300s
          script: |
            set -e

            # ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ${{ env.APP_DIR }}

            echo "=== Blue-Green ë°°í¬ ì‹œì‘ ==="
            echo "í˜„ì¬ ì‹œê°„: $(date)"

            # í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸
            CURRENT_ENV=$(grep -o "dig-duck-api-[blue|green]" nginx.conf | head -1 | sed 's/dig-duck-api-//')
            echo "í˜„ì¬ í™œì„± í™˜ê²½: $CURRENT_ENV"

            # ìƒˆë¡œìš´ í™˜ê²½ ê²°ì • (í˜„ì¬ê°€ blueë©´ greenìœ¼ë¡œ, greenì´ë©´ blueë¡œ)
            if [ "$CURRENT_ENV" = "blue" ]; then
              NEW_ENV="green"
              OLD_ENV="blue"
              NEW_PORT="8082"
            else
              NEW_ENV="blue"
              OLD_ENV="green"
              NEW_PORT="8081"
            fi

            echo "ìƒˆë¡œìš´ í™˜ê²½: $NEW_ENV"
            echo "í¬íŠ¸: $NEW_PORT"

            # Docker ì´ë¯¸ì§€ í’€
            echo "=== Docker ì´ë¯¸ì§€ í’€ë§ ==="
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ì´ë¯¸ì§€ íƒœê·¸ë¡œ)
            sed -i "s|DOCKER_IMAGE=.*|DOCKER_IMAGE=${{ env.DOCKER_IMAGE }}:${{ github.sha }}|" .env

            # ìƒˆë¡œìš´ í™˜ê²½ì˜ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì¬ì‹œì‘
            echo "=== $NEW_ENV í™˜ê²½ ì—…ë°ì´íŠ¸ ==="
            docker-compose stop dig-duck-api-$NEW_ENV || true
            docker-compose rm -f dig-duck-api-$NEW_ENV || true

            # ìƒˆë¡œìš´ í™˜ê²½ ì‹œì‘
            docker-compose up -d dig-duck-api-$NEW_ENV

            echo "=== $NEW_ENV í™˜ê²½ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ==="
            sleep 30

            # í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜
            health_check() {
              local env=$1
              local max_attempts=30
              local attempt=1
              
              echo "$env í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
              
              while [ $attempt -le $max_attempts ]; do
                echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $attempt/$max_attempts"
                
                # API ì§ì ‘ í—¬ìŠ¤ì²´í¬
                if curl -f -s --max-time 10 http://localhost:$NEW_PORT/health > /dev/null 2>&1; then
                  echo "âœ… $env í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                  return 0
                fi
                
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨, 5ì´ˆ í›„ ì¬ì‹œë„..."
                sleep 5
                attempt=$((attempt + 1))
              done
              
              echo "âŒ $env í™˜ê²½ í—¬ìŠ¤ì²´í¬ ìµœì¢… ì‹¤íŒ¨"
              return 1
            }

            # ìƒˆë¡œìš´ í™˜ê²½ í—¬ìŠ¤ì²´í¬
            if health_check $NEW_ENV; then
              echo "=== íŠ¸ë˜í”½ ìŠ¤ìœ„ì¹­ ==="
              
              # nginx.conf ë°±ì—…
              cp nginx.conf nginx.conf.backup
              
              # nginx.confì—ì„œ upstream ë³€ê²½
              sed -i "s/server dig-duck-api-$OLD_ENV:3000/# server dig-duck-api-$OLD_ENV:3000/" nginx.conf
              sed -i "s/# server dig-duck-api-$NEW_ENV:3000/server dig-duck-api-$NEW_ENV:3000/" nginx.conf
              
              # Docker Nginx ì¬ì‹œì‘
              docker-compose restart nginx-lb
              
              echo "=== ìŠ¤ìœ„ì¹­ í›„ ìµœì¢… í—¬ìŠ¤ì²´í¬ ==="
              sleep 10
              
              # ìµœì¢… í—¬ìŠ¤ì²´í¬
              if curl -f -s --max-time 10 http://localhost:8080/health > /dev/null 2>&1; then
                echo "âœ… ë°°í¬ ì„±ê³µ! $NEW_ENV í™˜ê²½ìœ¼ë¡œ íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ"
                
                # ì´ì „ í™˜ê²½ ì •ë¦¬ (ì„ íƒì‚¬í•­)
                echo "=== ì´ì „ í™˜ê²½ ì •ë¦¬ ==="
                docker-compose stop dig-duck-api-$OLD_ENV
                
                # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
                docker image prune -f
                
                echo "=== ë°°í¬ ì™„ë£Œ ==="
                echo "í™œì„± í™˜ê²½: $NEW_ENV"
                echo "ì™„ë£Œ ì‹œê°„: $(date)"
                
              else
                echo "âŒ ìŠ¤ìœ„ì¹­ í›„ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ë¡¤ë°± ìˆ˜í–‰"
                
                # nginx.conf ë³µì›
                cp nginx.conf.backup nginx.conf
                docker-compose restart nginx-lb
                
                # ìƒˆë¡œìš´ í™˜ê²½ ì¤‘ì§€
                docker-compose stop dig-duck-api-$NEW_ENV
                
                echo "âŒ ë¡¤ë°± ì™„ë£Œ. $OLD_ENV í™˜ê²½ìœ¼ë¡œ ë³µì›ë¨"
                exit 1
              fi
              
            else
              echo "âŒ $NEW_ENV í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ë¡¤ë°± ìˆ˜í–‰"
              
              # ìƒˆë¡œìš´ í™˜ê²½ ì¤‘ì§€
              docker-compose stop dig-duck-api-$NEW_ENV
              
              # ì´ì „ í™˜ê²½ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ì‹œì‘
              if ! docker-compose ps dig-duck-api-$OLD_ENV | grep -q "Up"; then
                echo "ì´ì „ í™˜ê²½ ì¬ì‹œì‘..."
                docker-compose up -d dig-duck-api-$OLD_ENV
              fi
              
              echo "âŒ ë°°í¬ ì‹¤íŒ¨. $OLD_ENV í™˜ê²½ ìœ ì§€"
              exit 1
            fi

      - name: Notify Slack on Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "ğŸš€ ë°°í¬ ì„±ê³µ! ìƒˆë¡œìš´ ë²„ì „ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "âŒ ë°°í¬ ì‹¤íŒ¨! ì´ì „ í™˜ê²½ìœ¼ë¡œ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤."
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deployment-summary:
    needs: [detect-changes, deploy-frontend, build-and-deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "# ğŸš€ Dig-Duck ë°°í¬ ìš”ì•½"
          echo ""
          echo "## ë³€ê²½ ê°ì§€ ê²°ê³¼"
          echo "- ğŸ¨ Frontend: ${{ needs.detect-changes.outputs.frontend }}"
          echo "- ğŸ”§ Backend: ${{ needs.detect-changes.outputs.backend }}"
          echo ""
          echo "## ë°°í¬ ê²°ê³¼"
          echo "- ğŸ¨ Frontend ë°°í¬: ${{ needs.deploy-frontend.result }}"
          echo "- ğŸ”§ Backend ë°°í¬: ${{ needs.build-and-deploy.result }}"
          echo ""

          # ë°°í¬ ì‹¤íŒ¨ ì²´í¬
          if [ "${{ needs.deploy-frontend.result }}" = "failure" ] || [ "${{ needs.build-and-deploy.result }}" = "failure" ]; then
            echo "âŒ ì¼ë¶€ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
            echo ""
            if [ "${{ needs.deploy-frontend.result }}" = "failure" ]; then
              echo "ğŸ¨ Frontend ë°°í¬ ì‹¤íŒ¨: S3/CloudFront ë°°í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            fi
            if [ "${{ needs.build-and-deploy.result }}" = "failure" ]; then
              echo "ğŸ”§ Backend ë°°í¬ ì‹¤íŒ¨: EC2/Docker ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
            fi
            exit 1
          else
            echo "âœ… ëª¨ë“  ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸŒ Frontend: https://digduck.app"
            echo "ğŸ”§ Backend: http://${{ secrets.EC2_HOST }}:8080"
            echo "ğŸ˜ Database: PostgreSQL 17"
          fi
