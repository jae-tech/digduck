name: Deploy Dig-Duck to S3, CloudFront and EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "ë°°í¬ ëŒ€ìƒ ì„ íƒ"
        required: true
        default: "both"
        type: choice
        options:
          - frontend
          - backend
          - both

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          echo "=== ë³€ê²½ëœ íŒŒì¼ë“¤ ==="
          git diff --name-only HEAD~1 HEAD || echo "ì´ˆê¸° ì»¤ë°‹"
          echo "===================="

          # Frontend ë³€ê²½ ê°ì§€ (dig-duck ì•± + shared packages)
          if git diff --name-only HEAD~1 HEAD | grep -E "^(apps/dig-duck/|packages/)" > /dev/null || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend ë³€ê²½ ê°ì§€"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "âŒ Frontend ë³€ê²½ ì—†ìŒ"
          fi

          # Backend ë³€ê²½ ê°ì§€ (api í´ë” + shared packages)
          if git diff --name-only HEAD~1 HEAD | grep -E "^(api/|packages/)" > /dev/null || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend ë³€ê²½ ê°ì§€"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "âŒ Backend ë³€ê²½ ì—†ìŒ"
          fi

  deploy-frontend:
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.frontend == 'true') || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.deploy_target == 'frontend' || github.event.inputs.deploy_target == 'both'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Build Dig-Duck app
        run: pnpm turbo run build --filter=dig-duck
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.PROD_API_URL }}
          VITE_APP_ENV: production
          VITE_LOG_LEVEL: error
          VITE_ENABLE_DEVTOOLS: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Sync to S3
        run: |
          aws s3 sync apps/dig-duck/dist/ s3://digduck.app --delete --cache-control max-age=60 --exclude "*" --include "*.html"
          aws s3 sync apps/dig-duck/dist/ s3://digduck.app --delete --cache-control max-age=31536000 --exclude "*.html"

      - name: Invalidate CloudFront Cache
        run: aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      - name: Frontend deployment notification
        run: echo "âœ… Frontend ë°°í¬ ì™„ë£Œ! S3 + CloudFront ì—…ë°ì´íŠ¸ë¨"

  deploy-backend:
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.backend == 'true') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.deploy_target == 'backend' || github.event.inputs.deploy_target == 'both'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Build API
        run: pnpm turbo run build --filter=api

      - name: Build Docker image
        run: |
          docker build -t dig-duck-api:latest -f api/Dockerfile .

      - name: Login to Docker Registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Tag and push Docker image
        run: |
          docker tag dig-duck-api:latest ${{ secrets.DOCKER_REGISTRY }}/dig-duck-api:latest
          docker tag dig-duck-api:latest ${{ secrets.DOCKER_REGISTRY }}/dig-duck-api:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/dig-duck-api:latest
          docker push ${{ secrets.DOCKER_REGISTRY }}/dig-duck-api:${{ github.sha }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          timeout: 300s
          script: |
            # Docker ì„¤ì¹˜ í™•ì¸ ë° ìë™ ì„¤ì¹˜
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Docker ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker ${{ secrets.EC2_USERNAME }}
              sudo systemctl start docker
              sudo systemctl enable docker
              echo "Docker ì„¤ì¹˜ ì™„ë£Œ"
            fi

            # Docker ì„œë¹„ìŠ¤ í™•ì¸
            if ! sudo systemctl is-active --quiet docker; then
              sudo systemctl start docker
            fi

            # Docker ë¡œê·¸ì¸
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker pull ${{ secrets.DOCKER_REGISTRY }}/dig-duck-api:latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ë°±ì—…
            if docker ps -q -f name=dig-duck-api > /dev/null 2>&1; then
              echo "ğŸ“¦ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë°±ì—… ë° ì¤‘ì§€..."
              docker commit dig-duck-api dig-duck-api:backup 2>/dev/null || true
              docker stop dig-duck-api
              docker rm dig-duck-api
            fi

            # PostgreSQL 17 ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì—†ìœ¼ë©´)
            if ! docker ps -q -f name=postgres17 > /dev/null 2>&1; then
              echo "ğŸ˜ PostgreSQL 17 ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
              
              # PostgreSQL ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
              mkdir -p ~/postgres-data
              
              docker run -d \
                --name postgres17 \
                --restart unless-stopped \
                -e POSTGRES_DB=latte \
                -e POSTGRES_USER=${{ secrets.DB_USER }} \
                -e POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }} \
                -p 5432:5432 \
                -v ~/postgres-data:/var/lib/postgresql/data \
                postgres:17-alpine
              
              # PostgreSQL ì‹œì‘ ëŒ€ê¸°
              echo "â³ PostgreSQL ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 15
              
              # DB ì—°ê²° í™•ì¸
              for i in {1..20}; do
                if docker exec postgres17 pg_isready -U ${{ secrets.DB_USER }} -d latte > /dev/null 2>&1; then
                  echo "âœ… PostgreSQL 17 ì¤€ë¹„ ì™„ë£Œ!"
                  break
                fi
                sleep 2
              done
            else
              echo "âœ… PostgreSQL 17 ì´ë¯¸ ì‹¤í–‰ ì¤‘"
            fi

            # ğŸ”„ ë¸”ë£¨ê·¸ë¦° ë°°í¬ ì‹œì‘
            echo "ğŸš€ ë¸”ë£¨ê·¸ë¦° ë°°í¬ ì‹œì‘..."

            # í˜„ì¬ í™œì„± ìƒ‰ìƒ í™•ì¸
            CURRENT_COLOR=$(cat /etc/nginx/current_color 2>/dev/null || echo "blue")
            if [ "$CURRENT_COLOR" = "blue" ]; then
              NEW_COLOR="green"
              NEW_PORT="8001"
              CURRENT_PORT="8000"
            else
              NEW_COLOR="blue" 
              NEW_PORT="8000"
              CURRENT_PORT="8001"
            fi

            echo "ìƒ‰ìƒ ì „í™˜: $CURRENT_COLOR (í¬íŠ¸:$CURRENT_PORT) -> $NEW_COLOR (í¬íŠ¸:$NEW_PORT)"

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ($NEW_COLOR) ì‹œì‘ ì¤‘..."
            docker run -d \
              --name dig-duck-api-$NEW_COLOR \
              --restart unless-stopped \
              --link postgres17:postgres \
              -p $NEW_PORT:8000 \
              -e NODE_ENV=production \
              -e DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/digduck \
              -e PORT=8000 \
              ${{ secrets.DOCKER_REGISTRY }}/dig-duck-api:latest

            # Health check ë° íŠ¸ë˜í”½ ì „í™˜
            echo "ğŸ” ìƒˆ ë²„ì „($NEW_COLOR) Health check ì¤‘..."
            sleep 15

            # Health check ì‹œë„
            HEALTH_SUCCESS=false
            for i in {1..30}; do
              if curl -f -s http://localhost:$NEW_PORT/health >/dev/null 2>&1; then
                echo "âœ… ìƒˆ ë²„ì „ Health check ì„±ê³µ! (ì‹œë„ $i/30)"
                HEALTH_SUCCESS=true
                break
              fi
              
              if [ $i -eq 15 ]; then
                echo "â³ Health check ì§„í–‰ ì¤‘... ($i/30)"
              fi
              sleep 2
            done

            if [ "$HEALTH_SUCCESS" = "true" ]; then
              echo "ğŸ”„ íŠ¸ë˜í”½ì„ ìƒˆ ë²„ì „($NEW_COLOR)ìœ¼ë¡œ ì „í™˜ ì¤‘..."
              
              # Nginx ì„¤ì • ë°±ì—…
              sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup.$(date +%Y%m%d_%H%M%S)
              
              # Nginx upstream í¬íŠ¸ ë³€ê²½
              sudo sed -i "s/server 127\.0\.0\.1:[0-9]* max_fails/server 127.0.0.1:$NEW_PORT max_fails/" /etc/nginx/nginx.conf
              
              # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ë¦¬ë¡œë“œ
              if sudo nginx -t; then
                sudo nginx -s reload
                echo "$NEW_COLOR" > /etc/nginx/current_color
                
                echo "âœ… íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
                echo "ğŸ“‹ í˜„ì¬ ìƒíƒœ:"
                docker ps --filter name=dig-duck-api --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                
                # 30ì´ˆ ëŒ€ê¸° í›„ ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
                echo "â³ 30ì´ˆ ëŒ€ê¸° í›„ ì´ì „ ì»¨í…Œì´ë„ˆ($CURRENT_COLOR) ì •ë¦¬..."
                sleep 30
                
                # ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
                docker stop dig-duck-api-$CURRENT_COLOR 2>/dev/null || true
                docker rm dig-duck-api-$CURRENT_COLOR 2>/dev/null || true
                
                echo "ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì™„ë£Œ"
                echo "ğŸ‰ ë¸”ë£¨ê·¸ë¦° ë°°í¬ ì„±ê³µ!"
                
                # ìµœì¢… ìƒíƒœ í™•ì¸
                echo "ğŸ“‹ ìµœì¢… ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
                docker ps | grep -E "(dig-duck-api|postgres17)"
                echo "ğŸ“‹ ìƒˆ ë²„ì „ ë¡œê·¸ (ìµœê·¼ 5ì¤„):"
                docker logs --tail 5 dig-duck-api-$NEW_COLOR
                
                exit 0
              else
                echo "âŒ Nginx ì„¤ì • ì—ëŸ¬! ì„¤ì • ë³µì› ì¤‘..."
                sudo cp /etc/nginx/nginx.conf.backup.$(date +%Y%m%d_%H%M%S) /etc/nginx/nginx.conf
                HEALTH_SUCCESS=false
              fi
            fi

            # Health check ì‹¤íŒ¨ ë˜ëŠ” Nginx ì„¤ì • ì‹¤íŒ¨ì‹œ ë¡¤ë°±
            echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì‹œì‘..."

            # ì‹¤íŒ¨í•œ ìƒˆ ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ($NEW_COLOR) ë¡œê·¸:"
            docker logs --tail 20 dig-duck-api-$NEW_COLOR 2>/dev/null || echo "ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop dig-duck-api-$NEW_COLOR 2>/dev/null || true
            docker rm dig-duck-api-$NEW_COLOR 2>/dev/null || true

            # ì´ì „ ì»¨í…Œì´ë„ˆê°€ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            if docker ps | grep -q dig-duck-api-$CURRENT_COLOR; then
              echo "âœ… ì´ì „ ë²„ì „($CURRENT_COLOR)ì´ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
              
              # ì´ì „ ë²„ì „ Health check
              if curl -f -s http://localhost:$CURRENT_PORT/health >/dev/null 2>&1; then
                echo "âœ… ì´ì „ ë²„ì „ì´ ì •ìƒ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ì˜í–¥ ì—†ìŒ."
              else
                echo "âš ï¸  ì´ì „ ë²„ì „ë„ ë¹„ì •ìƒì ì…ë‹ˆë‹¤. ìˆ˜ë™ í™•ì¸ í•„ìš”!"
              fi
            else
              echo "âŒ ì‹¬ê°: ì´ì „ ë²„ì „ë„ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤!"
            fi

            echo "ğŸ’¥ ë¸”ë£¨ê·¸ë¦° ë°°í¬ ì‹¤íŒ¨!"
            exit 1

  deployment-summary:
    needs: [detect-changes, deploy-frontend, deploy-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "# ğŸš€ Dig-Duck ë°°í¬ ìš”ì•½"
          echo ""
          echo "## ë³€ê²½ ê°ì§€ ê²°ê³¼"
          echo "- ğŸ¨ Frontend: ${{ needs.detect-changes.outputs.frontend }}"
          echo "- ğŸ”§ Backend: ${{ needs.detect-changes.outputs.backend }}"
          echo ""
          echo "## ë°°í¬ ê²°ê³¼"
          echo "- ğŸ¨ Frontend ë°°í¬: ${{ needs.deploy-frontend.result }}"
          echo "- ğŸ”§ Backend ë°°í¬: ${{ needs.deploy-backend.result }}"
          echo ""

          # ë°°í¬ ì‹¤íŒ¨ ì²´í¬
          if [ "${{ needs.deploy-frontend.result }}" = "failure" ] || [ "${{ needs.deploy-backend.result }}" = "failure" ]; then
            echo "âŒ ì¼ë¶€ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
            echo ""
            if [ "${{ needs.deploy-frontend.result }}" = "failure" ]; then
              echo "ğŸ¨ Frontend ë°°í¬ ì‹¤íŒ¨: S3/CloudFront ë°°í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            fi
            if [ "${{ needs.deploy-backend.result }}" = "failure" ]; then
              echo "ğŸ”§ Backend ë°°í¬ ì‹¤íŒ¨: EC2/Docker ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
            fi
            exit 1
          else
            echo "âœ… ëª¨ë“  ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸŒ Frontend: https://digduck.app"
            echo "ğŸ”§ Backend: http://your-ec2-ip:8000"
            echo "ğŸ˜ Database: PostgreSQL 17"
          fi
